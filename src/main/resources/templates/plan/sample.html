1. í¼ ë¡œë”©ì‹œ, ë‚ ì§œë³„ë¡œ ìŠ¤ì¼€ì¤„ì•„ì´ë””ë¡œ api í˜¸ì¶œ, ë‚ ì§œë³„ ìŠ¤ì¼€ì¤„ë“¤ì„ refreshDayCards(data, dayCard) í•¨ìˆ˜ë¡œ ë„˜ê¹€

2. refreshDayCards : (ë‚ ì§œ, ìŠ¤ì¼€ì¤„ë“¤)ì„ ë°›ê³  ì—…ë°ì´íŠ¸


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dayCards = document.querySelectorAll('.day-card');

        dayCards.forEach(dayCard => {
            const scheduleId = dayCard.dataset.scheduleId;
            fetch(`/api/travel/schedule-items?scheduleId=${scheduleId}`)
                .then(res => res.json())
                .then(data => {
                    refreshDayCards(data, dayCard); // ë°›ì•„ì˜¨ ë°ì´í„°ì™€ í•´ë‹¹ dayCard ì „ë‹¬
                    calculateTotalCost(); // ë¹„ìš©ë„ ì—…ë°ì´íŠ¸
                });
        });
    });

    function calculateTotalCost() {
        let total = 0;
        const costElements = document.querySelectorAll(".item-cost");

        costElements.forEach((costEl, idx) => {
            const costText = costEl.textContent.trim();
            const numericCost = parseInt(costText.replace(/[^\d]/g, ""), 10);
            if (!isNaN(numericCost)) {
                total += numericCost;
            }
        });
        document.getElementById("totalCost").textContent = `â‚©${total.toLocaleString()}`;
    }

    document.getElementById('autocomplete').addEventListener('input', function () {
        const query = this.value.trim();
        const list = document.getElementById('recommendationList');
        list.style.display = 'block';
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            loadRecommendations(cityIds, query);
        }, DEBOUNCE_DELAY);
    });

    function addMemo(button) {
        const scheduleId = button.closest('.day-card')?.dataset?.scheduleId;
        const memo = prompt("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

        if (memo === null || memo.trim() === "") return;

        const scheduleItem = {
            scheduleId,
            content: memo,
        };

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch('/api/travel/memo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken,
            },
            body: JSON.stringify(scheduleItem),
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                alert("ë©”ëª¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    function calculateDistance(prevPlace, newPlace, callback) {
        const R = 6371;
        const toRad = deg => deg * Math.PI / 180;
        const dLat = toRad(newPlace.latitude - prevPlace.latitude);
        const dLon = toRad(newPlace.longitude - prevPlace.longitude);
        const lat1 = toRad(prevPlace.latitude);
        const lat2 = toRad(newPlace.latitude);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;
        callback(`${distance.toFixed(2)} km`);
    }


    function refreshDayCards(data, dayCard) {
    const entryList = dayCard.querySelector('.entry-list');
    const originalItems = [];

    // ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì•„ì´í…œ ì²˜ë¦¬
    data.forEach((item, idx) => {
        const expectedCost = item.expectedCost || '';
        if (item.type === 'place') {
            originalItems.push({
                id: item.id,
                type: 'place',
                expectedCost,
                latitude: item.latitude,
                longitude: item.longitude,
                name: item.name || 'ì´ë¦„ ì—†ìŒ',
                address: item.address || ''
            });
        } else {
            originalItems.push({
                id: item.id,
                type: 'memo',
                expectedCost,
                content: item.content || 'ë‚´ìš© ì—†ìŒ'
            });
        }
    });

    entryList.innerHTML = '';

    let prevPlace = null;
    let placeCount = 0;

    originalItems.forEach(item => {
        const cost = parseInt(item.expectedCost?.replace(/[^\d]/g, '') || '0', 10);
        const row = document.createElement('div');
        row.className = item.type === 'place' ? 'entry-row place-row' : 'entry-row memo-row';
        if (item.id) row.dataset.id = item.id;

        const circle = document.createElement('div');
        circle.className = item.type === 'place' ? 'circle-number' : 'circle-memo';
        circle.innerText = item.type === 'place' ? ++placeCount : 'ğŸŸ¡';

        const contentItem = document.createElement('div');
        contentItem.className = item.type === 'place' ? 'entry-item place-entry' : 'entry-item';
        if (item.type === 'place') {
            contentItem.innerText = `ğŸ“ ${item.name} (${item.address})`;
            contentItem.dataset.latitude = item.latitude;
            contentItem.dataset.longitude = item.longitude;
            contentItem.dataset.id = item.id;
        } else {
            contentItem.innerHTML = `
                âœï¸ <span class="memo-text">${item.content}</span><br>`;
        }

        // í¸ì§‘ ë²„íŠ¼ ì˜ì—­
        const editArea = document.createElement('div');
        editArea.className = 'edit-area';

        const editToggle = document.createElement('span');
        editToggle.className = 'edit-toggle';
        editToggle.innerText = 'í¸ì§‘';

        const buttonWrapper = document.createElement('div');
        buttonWrapper.className = 'edit-buttons hidden';
        buttonWrapper.innerHTML = `
            <button class="btn-delete">ì‚­ì œ</button>
            <button class="btn-edit">ìˆ˜ì •</button>
            <button class="btn-cost">ë¹„ìš©ì¶”ê°€</button>
        `;

        editToggle.addEventListener('click', () => {
            buttonWrapper.classList.toggle('hidden');
        });

        // âœ… ì‚­ì œ
        buttonWrapper.querySelector('.btn-delete').addEventListener('click', () => {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch(`/api/travel/${item.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                }).then(res => {
                    if (res.ok) {
                        row.remove();
                    } else {
                        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        });

        // âœ… ìˆ˜ì •
        buttonWrapper.querySelector('.btn-edit').addEventListener('click', () => {
            if (item.type === 'place') {
                const newText = prompt('ì¥ì†Œ ì´ë¦„ê³¼ ì£¼ì†Œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”', contentItem.innerText);
                if (newText !== null) {
                    const [name, addressPart] = newText.split(' (');
                    const address = addressPart?.replace(')', '');
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    fetch(`/api/places/${item.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify({ name: name.trim(), address: address.trim() })
                    }).then(res => {
                        if (res.ok) {
                            contentItem.innerText = newText;
                        } else {
                            alert('ìˆ˜ì • ì‹¤íŒ¨');
                        }
                    });
                }
            } else {
                const memoText = contentItem.querySelector('.memo-text');
                const newText = prompt('ë©”ëª¨ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”', memoText.innerText);
                if (newText !== null) {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    fetch(`/api/memos/${item.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify({ content: newText })
                    }).then(res => {
                        if (res.ok) {
                            memoText.innerText = newText;
                        } else {
                            alert('ìˆ˜ì • ì‹¤íŒ¨');
                        }
                    });
                }
            }
        });

        // âœ… ë¹„ìš© ì¶”ê°€
        buttonWrapper.querySelector('.btn-cost').addEventListener('click', () => {
            const costText = contentItem.querySelector('.item-cost');
            const newCost = prompt('ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 5,000ì›)', costText.innerText);
            if (newCost !== null) {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                // ë¹„ìš© ì¶”ê°€ëŠ” ë©”ëª¨ì™€ ì¥ì†Œ ëª¨ë‘ì— í•´ë‹¹í•˜ëŠ” API í˜¸ì¶œë¡œ ìˆ˜ì •
                const url = item.type === 'place' ? `/api/places/${item.id}/cost` : `/api/memos/${item.id}/cost`;

                fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ costText: newCost })
                }).then(res => {
                    if (res.ok) {
                        costText.innerText = newCost;
                    } else {
                        alert('ë¹„ìš© ì¶”ê°€ ì‹¤íŒ¨');
                    }
                });
            }
        });

        editArea.appendChild(editToggle);
        editArea.appendChild(buttonWrapper);

        row.appendChild(circle);
        row.appendChild(contentItem);
        row.appendChild(editArea);
        entryList.appendChild(row);

        if (item.type === 'place' && prevPlace) {
            const distanceDiv = document.createElement('div');
            distanceDiv.className = 'distance-item';
            calculateDistance(prevPlace, {
                latitude: item.latitude,
                longitude: item.longitude
            }, (distanceText) => {
                distanceDiv.innerText = `ê±°ë¦¬: ${distanceText}`;
            });
            entryList.insertBefore(distanceDiv, row);
        }

        if (item.type === 'place') {
            prevPlace = {
                latitude: item.latitude,
                longitude: item.longitude
            };
        }
    });
    calculateTotalCost();
}
</script>