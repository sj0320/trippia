1. 폼 로딩시, 날짜별로 스케줄아이디로 api 호출, 날짜별 스케줄들을 refreshDayCards(data, dayCard) 함수로 넘김

2. refreshDayCards : (날짜, 스케줄들)을 받고 업데이트


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dayCards = document.querySelectorAll('.day-card');

        dayCards.forEach(dayCard => {
            const scheduleId = dayCard.dataset.scheduleId;
            fetch(`/api/travel/schedule-items?scheduleId=${scheduleId}`)
                .then(res => res.json())
                .then(data => {
                    refreshDayCards(data, dayCard); // 받아온 데이터와 해당 dayCard 전달
                    calculateTotalCost(); // 비용도 업데이트
                });
        });
    });

    function calculateTotalCost() {
        let total = 0;
        const costElements = document.querySelectorAll(".item-cost");

        costElements.forEach((costEl, idx) => {
            const costText = costEl.textContent.trim();
            const numericCost = parseInt(costText.replace(/[^\d]/g, ""), 10);
            if (!isNaN(numericCost)) {
                total += numericCost;
            }
        });
        document.getElementById("totalCost").textContent = `₩${total.toLocaleString()}`;
    }

    document.getElementById('autocomplete').addEventListener('input', function () {
        const query = this.value.trim();
        const list = document.getElementById('recommendationList');
        list.style.display = 'block';
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            loadRecommendations(cityIds, query);
        }, DEBOUNCE_DELAY);
    });

    function addMemo(button) {
        const scheduleId = button.closest('.day-card')?.dataset?.scheduleId;
        const memo = prompt("메모를 입력하세요:");

        if (memo === null || memo.trim() === "") return;

        const scheduleItem = {
            scheduleId,
            content: memo,
        };

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch('/api/travel/memo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken,
            },
            body: JSON.stringify(scheduleItem),
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                alert("메모 추가에 실패했습니다.");
            }
        });
    }

    function calculateDistance(prevPlace, newPlace, callback) {
        const R = 6371;
        const toRad = deg => deg * Math.PI / 180;
        const dLat = toRad(newPlace.latitude - prevPlace.latitude);
        const dLon = toRad(newPlace.longitude - prevPlace.longitude);
        const lat1 = toRad(prevPlace.latitude);
        const lat2 = toRad(newPlace.latitude);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;
        callback(`${distance.toFixed(2)} km`);
    }


    function refreshDayCards(data, dayCard) {
    const entryList = dayCard.querySelector('.entry-list');
    const originalItems = [];

    // 데이터 기반으로 아이템 처리
    data.forEach((item, idx) => {
        const expectedCost = item.expectedCost || '';
        if (item.type === 'place') {
            originalItems.push({
                id: item.id,
                type: 'place',
                expectedCost,
                latitude: item.latitude,
                longitude: item.longitude,
                name: item.name || '이름 없음',
                address: item.address || ''
            });
        } else {
            originalItems.push({
                id: item.id,
                type: 'memo',
                expectedCost,
                content: item.content || '내용 없음'
            });
        }
    });

    entryList.innerHTML = '';

    let prevPlace = null;
    let placeCount = 0;

    originalItems.forEach(item => {
        const cost = parseInt(item.expectedCost?.replace(/[^\d]/g, '') || '0', 10);
        const row = document.createElement('div');
        row.className = item.type === 'place' ? 'entry-row place-row' : 'entry-row memo-row';
        if (item.id) row.dataset.id = item.id;

        const circle = document.createElement('div');
        circle.className = item.type === 'place' ? 'circle-number' : 'circle-memo';
        circle.innerText = item.type === 'place' ? ++placeCount : '🟡';

        const contentItem = document.createElement('div');
        contentItem.className = item.type === 'place' ? 'entry-item place-entry' : 'entry-item';
        if (item.type === 'place') {
            contentItem.innerText = `📍 ${item.name} (${item.address})`;
            contentItem.dataset.latitude = item.latitude;
            contentItem.dataset.longitude = item.longitude;
            contentItem.dataset.id = item.id;
        } else {
            contentItem.innerHTML = `
                ✏️ <span class="memo-text">${item.content}</span><br>`;
        }

        // 편집 버튼 영역
        const editArea = document.createElement('div');
        editArea.className = 'edit-area';

        const editToggle = document.createElement('span');
        editToggle.className = 'edit-toggle';
        editToggle.innerText = '편집';

        const buttonWrapper = document.createElement('div');
        buttonWrapper.className = 'edit-buttons hidden';
        buttonWrapper.innerHTML = `
            <button class="btn-delete">삭제</button>
            <button class="btn-edit">수정</button>
            <button class="btn-cost">비용추가</button>
        `;

        editToggle.addEventListener('click', () => {
            buttonWrapper.classList.toggle('hidden');
        });

        // ✅ 삭제
        buttonWrapper.querySelector('.btn-delete').addEventListener('click', () => {
            if (confirm('정말 삭제하시겠습니까?')) {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch(`/api/travel/${item.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                }).then(res => {
                    if (res.ok) {
                        row.remove();
                    } else {
                        alert('삭제에 실패했습니다.');
                    }
                });
            }
        });

        // ✅ 수정
        buttonWrapper.querySelector('.btn-edit').addEventListener('click', () => {
            if (item.type === 'place') {
                const newText = prompt('장소 이름과 주소를 수정하세요', contentItem.innerText);
                if (newText !== null) {
                    const [name, addressPart] = newText.split(' (');
                    const address = addressPart?.replace(')', '');
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    fetch(`/api/places/${item.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify({ name: name.trim(), address: address.trim() })
                    }).then(res => {
                        if (res.ok) {
                            contentItem.innerText = newText;
                        } else {
                            alert('수정 실패');
                        }
                    });
                }
            } else {
                const memoText = contentItem.querySelector('.memo-text');
                const newText = prompt('메모 내용을 수정하세요', memoText.innerText);
                if (newText !== null) {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    fetch(`/api/memos/${item.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify({ content: newText })
                    }).then(res => {
                        if (res.ok) {
                            memoText.innerText = newText;
                        } else {
                            alert('수정 실패');
                        }
                    });
                }
            }
        });

        // ✅ 비용 추가
        buttonWrapper.querySelector('.btn-cost').addEventListener('click', () => {
            const costText = contentItem.querySelector('.item-cost');
            const newCost = prompt('비용을 입력하세요 (예: 5,000원)', costText.innerText);
            if (newCost !== null) {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                // 비용 추가는 메모와 장소 모두에 해당하는 API 호출로 수정
                const url = item.type === 'place' ? `/api/places/${item.id}/cost` : `/api/memos/${item.id}/cost`;

                fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ costText: newCost })
                }).then(res => {
                    if (res.ok) {
                        costText.innerText = newCost;
                    } else {
                        alert('비용 추가 실패');
                    }
                });
            }
        });

        editArea.appendChild(editToggle);
        editArea.appendChild(buttonWrapper);

        row.appendChild(circle);
        row.appendChild(contentItem);
        row.appendChild(editArea);
        entryList.appendChild(row);

        if (item.type === 'place' && prevPlace) {
            const distanceDiv = document.createElement('div');
            distanceDiv.className = 'distance-item';
            calculateDistance(prevPlace, {
                latitude: item.latitude,
                longitude: item.longitude
            }, (distanceText) => {
                distanceDiv.innerText = `거리: ${distanceText}`;
            });
            entryList.insertBefore(distanceDiv, row);
        }

        if (item.type === 'place') {
            prevPlace = {
                latitude: item.latitude,
                longitude: item.longitude
            };
        }
    });
    calculateTotalCost();
}
</script>