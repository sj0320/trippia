<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>여행 일정표</title>
    <script defer src="/js/place-recommend.js"></script>
    <script defer src="/js/place-handler.js"></script>
    <style>
        .itinerary-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .day-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .day-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .day-title strong {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .day-date {
            font-size: 0.95rem;
            color: #777;
        }

        .btn {
            margin-right: 10px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .btn-location {
            background-color: #6c757d; /* 회색 */
            color: white;
        }

        .btn-location:hover {
            background-color: #5a6268; /* 어두운 회색 */
        }

        .btn-memo {
            background-color: #f0ad4e; /* 금색 */
            color: white;
        }

        .btn-memo:hover {
            background-color: #ec971f; /* 더 어두운 금색 */
        }

        .entry-list {
            margin-top: 15px;
        }

        .entry-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .circle-number {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background-color: #495057; /* 미드나잇 블루 */
            color: white;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .circle-blank {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background-color: #ced4da; /* 연한 회색 */
            margin-right: 10px;
        }

        .entry-item {
            background-color: #f8f9fa; /* 연한 회색 배경 */
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .distance-item {
            margin-left: 36px;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        #placeModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 500px;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #autocomplete {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #recommendationList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }

        .recommend-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .recommend-item:hover {
            background-color: #e9ecef; /* 회색 강조 */
        }

        #placeModal button {
            padding: 8px 14px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #placeModal button:hover {
            background-color: #d32f2f;
        }

        .cost-input {
            width: 100px;
            margin-left: 10px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .total-cost {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            text-align: right;
            margin-top: 30px;
            padding-right: 20px;
        }


.entry-list {
    position: relative;
    margin-left: 20px;
    padding-left: 40px; /* 여유 공간 확보 */
}

.entry-list::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 56px; /* <- 여기 수정 */
    width: 2px;
    background-color: #ccc;
    z-index: 0;
}

/* 공통 entry row 설정 */
.entry-row {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
}

/* 숫자 동그라미 (장소) */
.circle-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #4e79a7;
    color: white;
    text-align: center;
    line-height: 32px; /* 동그라미 정중앙 텍스트 정렬 */
    font-weight: bold;
    z-index: 1;
    margin-right: 10px;
    flex-shrink: 0;
}

/* 메모 동그라미 */
.circle-memo {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    color: black;
    text-align: center;
    line-height: 54px;
    font-weight: bold;
    z-index: 1;
    margin-right: 10px;
    flex-shrink: 0;
}

/* 거리 텍스트 */
.distance-item {
    margin-left: 42px;
    margin-bottom: 5px;
    font-size: 0.9em;
    color: gray;
}


        .edit-area {
    position: absolute;
    top: 4px;
    right: 8px;
    font-size: 0.8rem;
    color: #555;
}

.edit-toggle {
    cursor: pointer;
    text-decoration: underline;
}

.edit-buttons {
    margin-top: 4px;
    display: flex;
    gap: 4px;
    flex-direction: column;
}

.edit-buttons.hidden {
    display: none;
}

.entry-row {
    position: relative;
}
    </style>
</head>
<body>
<div layout:fragment="content">
    <div id="placeModal">
        <label for="autocomplete" style="font-weight: bold;">장소 검색</label>
        <input id="autocomplete" type="text" placeholder="장소 검색..." autocomplete="off"/>
        <div id="recommendationList" style="margin-top: 1rem;"></div>
        <button onclick="closeModal()">❌ 닫기</button>
    </div>

    <div class="itinerary-container">
        <div th:each="schedule, iterStat : ${plan.schedules}" class="day-card"
             th:attr="data-schedule-id=${schedule.id}">

            <div class="day-title">
                <strong th:text="${iterStat.index + 1} + '일차'"></strong>
                <span class="day-date" th:text="${schedule.date}"></span>
            </div>

            <button class="btn btn-location" onclick="openPlaceModal(this)">➕ 장소 추가</button>
            <button class="btn btn-memo" onclick="addMemo(this)">📝 메모 추가</button>

            <div class="entry-list">
                <div th:each="item : ${schedule.scheduleItems}">
                    <div th:switch="${item.type.name()}">
                        <!-- 장소일 경우 -->
                        <div th:case="'PLACE'" class="entry-row">
                            <div class="entry-item place-entry"
                                 th:attr="data-latitude=${item.latitude}, data-longitude=${item.longitude}">
                                <p><strong th:text="${item.name}">장소 이름</strong></p>
                                <p th:text="'주소: ' + ${item.address}"></p>
                                <p class="item-cost" th:text="${item.expectedCost}">0</p>
                            </div>
                        </div>

                        <!-- 메모일 경우 -->
                        <div th:case="'MEMO'" class="entry-row">
                            <div class="entry-item memo-entry">
                                <span class="memo-text" th:text="${item.content}">기본 메모</span><br>
                                <p class="item-cost" th:text="${item.expectedCost}">0</p>
                            </div>
                        </div>
                        <!-- 예외 처리 -->
                        <div th:case="*">
                            <p>알 수 없는 일정 항목입니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="total-cost">
        총 예상 지출: <span id="totalCost">₩0</span>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
        calculateTotalCost();
    });

        function calculateTotalCost() {
                let total = 0;
                const costElements = document.querySelectorAll(".item-cost");

                console.log(`찾은 .item-cost 요소 개수: ${costElements.length}`);

                costElements.forEach((costEl, idx) => {
                    const costText = costEl.textContent.trim();
                    console.log(`[${idx}] 원본 텍스트: "${costText}"`);

                    const numericCost = parseInt(costText.replace(/[^\d]/g, ""), 10);
                    console.log(`[${idx}] 숫자로 변환된 비용: ${numericCost}`);

                    if (!isNaN(numericCost)) {
                        total += numericCost;
                    }
                });
                document.getElementById("totalCost").textContent = `₩${total.toLocaleString()}`;
            }

                let currentEntryList = null;
                let cityIds = /*[[${plan.cityIds}]]*/ [1, 2, 3];
                let debounceTimer;
                const DEBOUNCE_DELAY = 400;

                document.getElementById('autocomplete').addEventListener('input', function () {
                    const query = this.value.trim();
                    const list = document.getElementById('recommendationList');
                    list.style.display = 'block';
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        loadRecommendations(cityIds, query);
                    }, DEBOUNCE_DELAY);
                });

                document.addEventListener('DOMContentLoaded', () => {
                    refreshDayCards();
                });

                function addMemo(button) {
                    const scheduleId = button.closest('.day-card')?.dataset?.scheduleId;
                    const memo = prompt("메모를 입력하세요:");

                    if (memo === null || memo.trim() === "") return;

                    const scheduleItem = {
                        scheduleId,
                        content: memo,
                    };

                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    fetch('/api/travel/memo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken,
                        },
                        body: JSON.stringify(scheduleItem),
                    }).then(res => {
                        if (res.ok) {
                            location.reload();
                        } else {
                            alert("메모 추가에 실패했습니다.");
                        }
                    });
                }


                function calculateDistance(prevPlace, newPlace, callback) {
                    const R = 6371;
                    const toRad = deg => deg * Math.PI / 180;
                    const dLat = toRad(newPlace.latitude - prevPlace.latitude);
                    const dLon = toRad(newPlace.longitude - prevPlace.longitude);
                    const lat1 = toRad(prevPlace.latitude);
                    const lat2 = toRad(newPlace.latitude);
                    const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    const distance = R * c;
                    callback(`${distance.toFixed(2)} km`);
                }

                function refreshDayCards() {
                    const dayCards = document.querySelectorAll('.day-card');

                    dayCards.forEach(dayCard => {
                        const entryList = dayCard.querySelector('.entry-list');
                        const originalItems = [];

                        const rows = Array.from(entryList.querySelectorAll('.entry-row'));
                        rows.forEach(row => {
                            const place = row.querySelector('.place-entry');
                            const expectedCost = row.querySelector('.item-cost')?.innerText || '';
                            if (place) {
                                originalItems.push({
                                    id: place.dataset.id, // id 포함
                                    type: 'place',
                                    expectedCost,
                                    latitude: parseFloat(place.dataset.latitude),
                                    longitude: parseFloat(place.dataset.longitude),
                                    name: place.querySelector('strong')?.innerText || '이름 없음',
                                    address: place.querySelector('p:nth-child(2)')?.innerText.replace('주소: ', '') || ''
                                });
                            } else {
                                const content = row.querySelector('.memo-text')?.innerText || '내용 없음';
                                const costText = row.querySelector('.memo-cost')?.innerText || '';
                                originalItems.push({
                                    id: row.dataset.id, // 메모 항목도 ID 필요
                                    type: 'memo',
                                    expectedCost,
                                    content
                                });
                            }
                        });

                        entryList.innerHTML = '';

                        let prevPlace = null;
                        let placeCount = 0;

                        originalItems.forEach(item => {
                            const cost = parseInt(item.expectedCost?.replace(/[^\d]/g, '') || '0', 10);
                            const row = document.createElement('div');
                            row.className = item.type === 'place' ? 'entry-row place-row' : 'entry-row memo-row';
                            if (item.id) row.dataset.id = item.id;

                            const circle = document.createElement('div');
                            circle.className = item.type === 'place' ? 'circle-number' : 'circle-memo';
                            circle.innerText = item.type === 'place' ? ++placeCount : '🟡';

                            const contentItem = document.createElement('div');
                            contentItem.className = item.type === 'place' ? 'entry-item place-entry' : 'entry-item';
                            if (item.type === 'place') {
                                contentItem.innerText = `📍 ${item.name} (${item.address})`;
                                contentItem.dataset.latitude = item.latitude;
                                contentItem.dataset.longitude = item.longitude;
                                contentItem.dataset.id = item.id;
                            } else {
                                contentItem.innerHTML = `
                                    ✏️ <span class="memo-text">${item.content}</span><br>`;
                            }

                            // 편집 버튼 영역
                            const editArea = document.createElement('div');
                            editArea.className = 'edit-area';

                            const editToggle = document.createElement('span');
                            editToggle.className = 'edit-toggle';
                            editToggle.innerText = '편집';

                            const buttonWrapper = document.createElement('div');
                            buttonWrapper.className = 'edit-buttons hidden';
                            buttonWrapper.innerHTML = `
                                <button class="btn-delete">삭제</button>
                                <button class="btn-edit">수정</button>
                                <button class="btn-cost">비용추가</button>
                            `;

                            editToggle.addEventListener('click', () => {
                                buttonWrapper.classList.toggle('hidden');
                            });

                            // ✅ 삭제
                            buttonWrapper.querySelector('.btn-delete').addEventListener('click', () => {
                                if (confirm('정말 삭제하시겠습니까?')) {
                                    const endpoint = item.type === 'place' ? `/api/places/${item.id}` : `/api/memos/${item.id}`;
                                    fetch(endpoint, {
                                        method: 'DELETE'
                                    }).then(res => {
                                        if (res.ok) {
                                            row.remove();
                                            refreshDayCards();
                                        } else {
                                            alert('삭제에 실패했습니다.');
                                        }
                                    });
                                }
                            });

                            // ✅ 수정
                            buttonWrapper.querySelector('.btn-edit').addEventListener('click', () => {
                                if (item.type === 'place') {
                                    const newText = prompt('장소 이름과 주소를 수정하세요', contentItem.innerText);
                                    if (newText !== null) {
                                        const [name, addressPart] = newText.split(' (');
                                        const address = addressPart?.replace(')', '');
                                        fetch(`/api/places/${item.id}`, {
                                            method: 'PATCH',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ name: name.trim(), address: address.trim() })
                                        }).then(res => {
                                            if (res.ok) {
                                                contentItem.innerText = newText;
                                            } else {
                                                alert('수정 실패');
                                            }
                                        });
                                    }
                                } else {
                                    const memoText = contentItem.querySelector('.memo-text');
                                    const newText = prompt('메모 내용을 수정하세요', memoText.innerText);
                                    if (newText !== null) {
                                        fetch(`/api/memos/${item.id}`, {
                                            method: 'PATCH',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ content: newText })
                                        }).then(res => {
                                            if (res.ok) {
                                                memoText.innerText = newText;
                                            } else {
                                                alert('수정 실패');
                                            }
                                        });
                                    }
                                }
                            });

                            // ✅ 비용 추가
                            buttonWrapper.querySelector('.btn-cost').addEventListener('click', () => {
                                if (item.type === 'memo') {
                                    const costText = contentItem.querySelector('.memo-cost');
                                    const newCost = prompt('비용을 입력하세요 (예: 5,000원)', costText.innerText);
                                    if (newCost !== null) {
                                        fetch(`/api/memos/${item.id}/cost`, {
                                            method: 'PATCH',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ costText: newCost })
                                        }).then(res => {
                                            if (res.ok) {
                                                costText.innerText = newCost;
                                            } else {
                                                alert('비용 추가 실패');
                                            }
                                        });
                                    }
                                } else {
                                    alert('비용 추가는 메모 항목에만 가능합니다.');
                                }
                            });

                            editArea.appendChild(editToggle);
                            editArea.appendChild(buttonWrapper);

                            row.appendChild(circle);
                            row.appendChild(contentItem);
                            row.appendChild(editArea);
                            entryList.appendChild(row);

                            if (item.type === 'place' && prevPlace) {
                                const distanceDiv = document.createElement('div');
                                distanceDiv.className = 'distance-item';
                                calculateDistance(prevPlace, {
                                    latitude: item.latitude,
                                    longitude: item.longitude
                                }, (distanceText) => {
                                    distanceDiv.innerText = `거리: ${distanceText}`;
                                });
                                entryList.insertBefore(distanceDiv, row);
                            }

                            if (item.type === 'place') {
                                prevPlace = {
                                    latitude: item.latitude,
                                    longitude: item.longitude
                                };
                            }
                        });
                    });
                }
    </script>
    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api-key')} + '&libraries=places,geometry&loading=async'" async></script>
</div>
</body>
</html>