<script>
  let currentEditingItem = null;
let currentDayCard = null;

// Ï†ÄÏû• Î≤ÑÌäº Î¶¨Ïä§ÎÑà - Ï§ëÎ≥µ Îì±Î°ù Î∞©ÏßÄ
document.addEventListener('DOMContentLoaded', () => {
    const autocomplete = document.getElementById('autocomplete');
    if (autocomplete) {
        autocomplete.addEventListener('input', function () {
            const query = this.value.trim();
            const list = document.getElementById('recommendationList');
            list.style.display = 'block';
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                loadRecommendations(cityIds, query);
            }, DEBOUNCE_DELAY);
        });
    }

    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    modalSaveBtn?.addEventListener('click', () => {
        if (!currentEditingItem || !currentDayCard) return;

        const formattedCost = document.getElementById('modalCost').value;
        const numericCost = parseInt(formattedCost.replace(/[^\d]/g, ''), 10) || 0;
        const timeValue = document.getElementById('modalTime').value;

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        fetch(`/api/travel/schedule-item/${currentEditingItem.id}/meta`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                expectedCost: numericCost,
                time: timeValue
            })
        }).then(res => {
            if (res.ok) {
                const scheduleId = currentDayCard?.dataset?.scheduleId;
                if (scheduleId) {
                    fetch(`/api/travel/schedule-items?scheduleId=${scheduleId}`)
                        .then(res => res.json())
                        .then(data => {
                            refreshDayCards(data, currentDayCard);
                        });
                }
            } else {
                alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        });

        document.getElementById('editModal').classList.remove('active');
    });

    modalCancelBtn?.addEventListener('click', () => {
        document.getElementById('editModal').classList.remove('active');
    });
});




  document.addEventListener('DOMContentLoaded', () => {
      const dayCards = document.querySelectorAll('.day-card');

      dayCards.forEach(dayCard => {
          const scheduleId = dayCard.dataset.scheduleId;
          fetch(`/api/travel/schedule-items?scheduleId=${scheduleId}`)
              .then(res => res.json())
              .then(data => {
                  refreshDayCards(data, dayCard); // Î∞õÏïÑÏò® Îç∞Ïù¥ÌÑ∞ÏôÄ Ìï¥Îãπ dayCard Ï†ÑÎã¨
              });
      });
      calculateTotalCost();
  });

  // Îã§Î•∏ ÏòÅÏó≠ ÌÅ¥Î¶≠ Ïãú Ïà®ÍπÄ Ï≤òÎ¶¨
  document.addEventListener('click', (e) => {
      // Ìé∏Ïßë ÏòÅÏó≠ Î∞îÍπ•ÏùÑ ÌÅ¥Î¶≠ÌñàÏùÑ ÎïåÎßå ÎèôÏûë
      if (!e.target.closest('.edit-area')) {
          document.querySelectorAll('.edit-buttons').forEach(btn => btn.classList.add('hidden'));
      }
  });


  function calculateTotalCost() {
      let total = 0;
      const costElements = document.querySelectorAll(".item-cost");

<!--            console.log(`Ï¥ù ${costElements.length}Í∞úÏùò .item-cost ÏöîÏÜåÎ•º Ï∞æÏùå`);-->

      costElements.forEach((costEl, idx) => {
          const costText = costEl.textContent.trim();
          const numericCost = parseInt(costText.replace(/[^\d]/g, ""), 10);

<!--                console.log(`[${idx}] ÏõêÎ≥∏ ÌÖçÏä§Ìä∏: "${costText}"`);-->
<!--                console.log(`[${idx}] Ïà´Ïûê Î≥ÄÌôò Í∞í: ${numericCost}`);-->

          if (!isNaN(numericCost)) {
              total += numericCost;
          }
      });

      console.log(`Ï¥ù Í≥ÑÏÇ∞Îêú ÎπÑÏö©: ‚Ç©${total.toLocaleString()}`);
      document.getElementById("totalCost").textContent = `‚Ç©${total.toLocaleString()}`;
  }


  function addMemo(button) {
      const scheduleId = button.closest('.day-card')?.dataset?.scheduleId;
      const memo = prompt("Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");

      if (memo === null || memo.trim() === "") return;

      const scheduleItem = {
          scheduleId,
          content: memo,
      };

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch('/api/travel/memo', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              [csrfHeader]: csrfToken,
          },
          body: JSON.stringify(scheduleItem),
      }).then(res => {
          if (res.ok) {
              location.reload();
          } else {
              alert("Î©îÎ™® Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          }
      });
  }

  function calculateDistance(prevPlace, newPlace, callback) {
      const R = 6371;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(newPlace.latitude - prevPlace.latitude);
      const dLon = toRad(newPlace.longitude - prevPlace.longitude);
      const lat1 = toRad(prevPlace.latitude);
      const lat2 = toRad(newPlace.latitude);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c;
      callback(`${distance.toFixed(2)} km`);
  }

  function refreshDayCards(data, dayCard) {
      const entryList = dayCard.querySelector('.entry-list');
      const originalItems = [];

      // Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞òÏúºÎ°ú ÏïÑÏù¥ÌÖú Ï≤òÎ¶¨
      data.forEach((item, idx) => {
          if (item.type === 'PLACE') {
              originalItems.push({
                  id: item.id,
                  type: 'place',
                  latitude: item.latitude,
                  longitude: item.longitude,
                  name: item.name || 'Ïù¥Î¶Ñ ÏóÜÏùå',
                  address: item.address || '',
                  expectedCost : item.expectedCost,
              });
          } else {
              originalItems.push({
                  id: item.id,
                  type: 'memo',
                  content: item.content || 'ÎÇ¥Ïö© ÏóÜÏùå',
                  expectedCost : item.expectedCost
              });
          }
      });

      entryList.innerHTML = '';

      let prevPlace = null;
      let placeCount = 0;

      originalItems.forEach(item => {
          const row = document.createElement('div');
          row.className = item.type === 'place' ? 'entry-row place-row' : 'entry-row memo-row';
          if (item.id) row.dataset.id = item.id;

          const circle = document.createElement('div');
          circle.className = item.type === 'place' ? 'circle-number' : 'circle-memo';
          circle.innerText = item.type === 'place' ? ++placeCount : 'üü°';

          const contentItem = document.createElement('div');
          contentItem.className = item.type === 'place' ? 'entry-item place-entry' : 'entry-item';
          if (item.type === 'place') {
              contentItem.innerText = `üìç ${item.name} (${item.address})`;
              contentItem.dataset.latitude = item.latitude;
              contentItem.dataset.longitude = item.longitude;
              contentItem.dataset.id = item.id;
              contentItem.dataset.expectedCost = item.expectedCost;
          } else {
              contentItem.innerHTML = `‚úèÔ∏è <span class="memo-text">${item.content}</span><br>`;
              contentItem.dataset.id = item.id;
              contentItem.dataset.expectedCost = item.expectedCost;
          }

          // Ìé∏Ïßë Î≤ÑÌäº ÏòÅÏó≠
          const editArea = document.createElement('div');
          editArea.className = 'edit-area';

          const editToggle = document.createElement('span');
          editToggle.className = 'edit-toggle';
          editToggle.innerText = 'Ìé∏Ïßë';

          const buttonWrapper = document.createElement('div');
          buttonWrapper.className = 'edit-buttons hidden';
          buttonWrapper.innerHTML = `
              <button class="btn-delete">ÏÇ≠Ï†ú</button>
              <button class="btn-edit">ÏàòÏ†ï</button>
              <button class="btn-cost-time">ÏßÄÏ∂ú¬∑ÏãúÍ∞Ñ</button>
          `;

          editToggle.addEventListener('click', (e) => {
              e.stopPropagation();
              document.querySelectorAll('.edit-buttons').forEach(btn => btn.classList.add('hidden'));
              buttonWrapper.classList.remove('hidden');
          });

          // ‚úÖ ÏÇ≠Ï†ú
          buttonWrapper.querySelector('.btn-delete').addEventListener('click', (event) => {
              if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                  const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                  fetch(`/api/travel/${item.id}`, {
                      method: 'DELETE',
                      headers: {
                          'Content-Type': 'application/json',
                          [csrfHeader]: csrfToken
                      }
                  }).then(res => {
                      if (res.ok) {
                          // ‚úÖ ÏÇ≠Ï†ú ÏÑ±Í≥µ ÌõÑ: Ìï¥Îãπ dayCardÎ•º Ï∞æÏïÑÏÑú scheduleIdÎ°ú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ fetch
                          const dayCard = event.target.closest('.day-card');
                          const scheduleId = dayCard.dataset.scheduleId;

                          fetch(`/api/travel/schedule-items?scheduleId=${scheduleId}`)
                              .then(res => res.json())
                              .then(data => {
                                  refreshDayCards(data, dayCard); // ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î°ú Í∞±Ïã†
                              });
                      } else {
                          alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                      }
                  });
              }
          });

          // ‚úÖ ÏßÄÏ∂ú¬∑ÏãúÍ∞Ñ

          buttonWrapper.querySelector('.btn-cost-time').addEventListener('click', () => {
              const modal = document.getElementById('editModal');
              modal.classList.add('active');
              currentEditingItem = item;
              currentDayCard = buttonWrapper.closest('.day-card');

              const rawCost = parseInt(String(item.expectedCost || '').replace(/[^\d]/g, '')) || 0;
              document.getElementById('modalCost').value = rawCost.toLocaleString();
              document.getElementById('modalTime').value = item.time || '';
          });

          // ÏßÄÏ∂ú ÏàòÏ†ï Í∞í ÏûÖÎ†•
          document.getElementById('modalCost').addEventListener('input', (e) => {
              const val = e.target.value.replace(/[^\d]/g, '');
              if (val) {
                  e.target.value = Number(val).toLocaleString();
              } else {
                  e.target.value = '';
              }
          });

          // Ï∑®ÏÜå Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î™®Îã¨ Îã´Í∏∞
          document.getElementById('modalCancelBtn').addEventListener('click', () => {
              document.getElementById('editModal').classList.remove('active');
          });


          editArea.appendChild(editToggle);
          editArea.appendChild(buttonWrapper);

          row.appendChild(circle);
          row.appendChild(contentItem);
          row.appendChild(editArea);
          entryList.appendChild(row);

          if (item.type === 'place' && prevPlace) {
              const distanceDiv = document.createElement('div');
              distanceDiv.className = 'distance-item';
              calculateDistance(prevPlace, {
                  latitude: item.latitude,
                  longitude: item.longitude
              }, (distanceText) => {
                  distanceDiv.innerText = `Í±∞Î¶¨: ${distanceText}`;
              });
              entryList.insertBefore(distanceDiv, row);
          }

          if (item.type === 'place') {
              prevPlace = {
                  latitude: item.latitude,
                  longitude: item.longitude
              };
          }
      });
  }
</script>