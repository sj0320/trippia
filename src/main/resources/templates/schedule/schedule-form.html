<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>ì—¬í–‰ ì¼ì •í‘œ</title>
    <!-- ìƒëµ -->
</head>

<!-- ğŸ”¥ ì—¬ê¸°ì„œë¶€í„°ëŠ” body ì—†ì´ ë°”ë¡œ fragmentë§Œ -->
<div layout:fragment="content">

    <!-- ì¥ì†Œ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="placeModal" style="display:none; position:fixed; ...">
        <label for="autocomplete"></label>
        <input id="autocomplete" type="text" placeholder="ì¥ì†Œ ê²€ìƒ‰..." oninput="handleInput()">
        <div id="recommendationList"></div>
        <button onclick="closeModal()">âŒ ë‹«ê¸°</button>
    </div>

    <div class="itinerary-container">
        <div th:each="day, iterStat : ${dateList}" class="day-card">
            <div class="day-title">
                Day [[${iterStat.index + 1}]] ([[${day}]])
            </div>

            <button class="btn btn-location" onclick="openPlaceModal(this)">â• ì¥ì†Œ ì¶”ê°€</button>
            <button class="btn btn-memo" onclick="addMemo(this)">ğŸ“ ë©”ëª¨ ì¶”ê°€</button>

            <div class="entry-list"></div>
        </div>
    </div>

    <script>
        let currentEntryList = null;
let cityName = /*[[${cityName}]]*/ 'ì„œìš¸'; // ì„œë²„ì—ì„œ ëª¨ë¸ë¡œ ë„˜ê¸´ ë„ì‹œ ì´ë¦„

function openPlaceModal(button) {
    currentEntryList = button.closest('.day-card').querySelector('.entry-list');
    document.getElementById('placeModal').style.display = 'block';
    document.getElementById('autocomplete').value = '';
    document.getElementById('recommendationList').style.display = 'block';
    loadRecommendations(cityName);
}

function closeModal() {
    document.getElementById('placeModal').style.display = 'none';
}

function handleInput() {
    const input = document.getElementById('autocomplete').value;
    document.getElementById('recommendationList').style.display = input.trim() === '' ? 'block' : 'none';
}

function loadRecommendations(city) {
    fetch(`/schedule/places/recommend?city=${encodeURIComponent(city)}`)
        .then(res => res.json())
        .then(places => {
            const list = document.getElementById('recommendationList');
            list.innerHTML = '';
            places.forEach(place => {
                const div = document.createElement('div');
                div.className = 'recommend-item';
                div.innerText = `ğŸ“ ${place.name}`;
                div.onclick = () => {
                    const entry = document.createElement('div');
                    entry.className = 'entry-item';
                    entry.innerText = `ğŸ“ ${place.name} (${place.address})`;
                    currentEntryList.appendChild(entry);
                    closeModal();
                };
                list.appendChild(div);
            });
        });
}

        function addMemo(button) {
            const entryList = button.closest('.day-card').querySelector('.entry-list');
            const memo = prompt("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (memo) {
                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerText = `ğŸ“ ${memo}`;
                entryList.appendChild(div);
            }
        }

        function initAutocomplete() {
    const input = document.getElementById('autocomplete');
    const autocomplete = new google.maps.places.Autocomplete(input);

    autocomplete.addListener('place_changed', function () {
        const place = autocomplete.getPlace();
        if (!place.name) return;

        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerText = `ğŸ“ ${place.name} (${place.formatted_address || ''})`;
        currentEntryList.appendChild(div);
        closeModal();
    });
}

        // êµ¬ê¸€ Maps APIê°€ ë¶ˆëŸ¬ì§„ ë’¤ ì‹¤í–‰
        window.initAutocomplete = initAutocomplete;
    </script>

    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api-key')} + '&libraries=places&callback=initAutocomplete'"
            async defer></script>
</div>