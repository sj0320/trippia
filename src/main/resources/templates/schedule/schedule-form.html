<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>여행 일정표</title>
    <style>
        .itinerary-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .day-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .day-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .btn {
            margin-right: 10px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        .btn-location {
            background-color: #4CAF50;
            color: white;
        }

        .btn-location:hover {
            background-color: #45a049;
        }

        .btn-memo {
            background-color: #2196F3;
            color: white;
        }

        .btn-memo:hover {
            background-color: #1976D2;
        }

        .entry-list {
            margin-top: 15px;
        }

        .entry-item {
            background-color: #f1f1f1;
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        /* 모달 스타일 */
        #placeModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 500px;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #autocomplete {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #recommendationList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }

        .recommend-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .recommend-item:hover {
            background-color: #e0f7fa;
        }

        #placeModal button {
            padding: 8px 14px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #placeModal button:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
<div layout:fragment="content">

    <!-- 장소 검색 모달 -->
    <div id="placeModal">
        <label for="autocomplete" style="font-weight: bold;">장소 검색</label>
        <!-- 일반 input 필드로 변경 -->
        <input
                id="autocomplete"
                type="text"
                style="width: 100%; max-width: 500px;"
                placeholder="장소 검색..."
                oninput="handleInput()"
                autocomplete="off"
        />
        <!-- 추천 장소 목록 -->
        <div id="recommendationList" style="margin-top: 1rem;"></div>
        <button onclick="closeModal()">❌ 닫기</button>
    </div>

    <div class="itinerary-container">
        <div th:each="day, iterStat : ${dateList}" class="day-card">
            <div class="day-title">
                Day [[${iterStat.index + 1}]] ([[${day}]])
            </div>

            <button class="btn btn-location" onclick="openPlaceModal(this)">➕ 장소 추가</button>
            <button class="btn btn-memo" onclick="addMemo(this)">📝 메모 추가</button>

            <div class="entry-list"></div>
        </div>
    </div>

    <script>
        let currentEntryList = null;
        let cityIds = /*[[${cityIds}]]*/ [1, 2, 3]; // 서버에서 모델로 넘긴 도시 ID 리스트

        let debounceTimer;
        const DEBOUNCE_DELAY = 400;

        document.getElementById('autocomplete').addEventListener('input', function () {
            const query = this.value.trim();

            // 추천 리스트 표시 여부
            const list = document.getElementById('recommendationList');
            list.style.display = 'block';

            // 디바운스 적용
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                loadRecommendations(cityIds, query);
            }, DEBOUNCE_DELAY);
        });

        function openPlaceModal(button) {
            currentEntryList = button.closest('.day-card').querySelector('.entry-list');
            document.getElementById('placeModal').style.display = 'block';
            const input = document.getElementById('autocomplete');
            const list = document.getElementById('recommendationList');
            input.value = '';
            list.style.display = 'block';
            loadRecommendations(cityIds);
        }

        function closeModal() {
            document.getElementById('placeModal').style.display = 'none';
        }

        function loadRecommendations(cityIds, query = '') {
            const queryParam = cityIds.map(id => `cityIds=${id}`).join('&') + (query ? `&query=${encodeURIComponent(query)}` : '');
            fetch(`/travel/places/recommend?${queryParam}`)
                .then(res => res.json())
                .then(places => {
                    const list = document.getElementById('recommendationList');
                    list.innerHTML = '';

                    if (places.length === 0) {
                        list.innerHTML = '<p>추천 장소가 없습니다.</p>';
                        return;
                    }

                    places.forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'recommend-item';
                        div.style.border = '1px solid #ccc';
                        div.style.padding = '10px';
                        div.style.marginBottom = '10px';
                        div.style.borderRadius = '8px';
                        div.style.cursor = 'pointer';
                        div.style.display = 'flex';
                        div.style.alignItems = 'center';
                        div.style.gap = '10px';

                        // 썸네일 이미지
                        if (place.thumbnailUrl) {
                            const img = document.createElement('img');
                            img.src = place.thumbnailUrl;
                            img.alt = place.placeName;
                            img.style.width = '60px';
                            img.style.height = '60px';
                            img.style.borderRadius = '6px';
                            img.style.objectFit = 'cover';
                            div.appendChild(img);
                        }

                        // 텍스트 정보
                        const infoDiv = document.createElement('div');
                        infoDiv.style.flex = '1';

                        const nameEl = document.createElement('div');
                        nameEl.style.fontWeight = 'bold';
                        nameEl.innerText = `📍 ${place.placeName}`;
                        infoDiv.appendChild(nameEl);

                        const addressEl = document.createElement('div');
                        addressEl.style.fontSize = '0.9rem';
                        addressEl.style.color = '#555';
                        addressEl.innerText = place.address;
                        infoDiv.appendChild(addressEl);

                        if (place.themes && place.themes.length > 0) {
                            const themeContainer = document.createElement('div');
                            place.themes.forEach(theme => {
                                const tag = document.createElement('span');
                                tag.innerText = theme;
                                tag.style.fontSize = '0.75rem';
                                tag.style.background = '#f0f0f0';
                                tag.style.color = '#333';
                                tag.style.padding = '2px 6px';
                                tag.style.marginRight = '5px';
                                tag.style.borderRadius = '4px';
                                themeContainer.appendChild(tag);
                            });
                            infoDiv.appendChild(themeContainer);
                        }

                        div.appendChild(infoDiv);

                        div.onclick = () => {
                            const entry = document.createElement('div');
                            entry.className = 'entry-item';
                            entry.innerText = `📍 ${place.placeName} (${place.address})`;
                            currentEntryList.appendChild(entry);
                            closeModal();
                        };

                        list.appendChild(div);
                    });
                });
        }

        function addMemo(button) {
            const entryList = button.closest('.day-card').querySelector('.entry-list');
            const memo = prompt("메모를 입력하세요:");
            if (memo) {
                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerText = `📝 ${memo}`;
                entryList.appendChild(div);
            }
        }
    </script>

</div>
</body>
</html>