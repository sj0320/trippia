<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>Ïó¨Ìñâ ÏùºÏ†ïÌëú</title>
    <style>
        .itinerary-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .day-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .day-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .btn {
            margin-right: 10px;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        .btn-location {
            background-color: #4CAF50;
            color: white;
        }

        .btn-location:hover {
            background-color: #45a049;
        }

        .btn-memo {
            background-color: #2196F3;
            color: white;
        }

        .btn-memo:hover {
            background-color: #1976D2;
        }

        .entry-list {
            margin-top: 15px;
        }

        .entry-item {
            background-color: #f1f1f1;
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        #placeModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 500px;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #autocomplete {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #recommendationList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }

        .recommend-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .recommend-item:hover {
            background-color: #e0f7fa;
        }

        #placeModal button {
            padding: 8px 14px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #placeModal button:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
<div layout:fragment="content">

    <!-- Ïû•ÏÜå Í≤ÄÏÉâ Î™®Îã¨ -->
    <div id="placeModal">
        <label for="autocomplete" style="font-weight: bold;">Ïû•ÏÜå Í≤ÄÏÉâ</label>
        <input id="autocomplete" type="text" placeholder="Ïû•ÏÜå Í≤ÄÏÉâ..." oninput="handleInput()">
        <div id="recommendationList"></div>
        <button onclick="closeModal()">‚ùå Îã´Í∏∞</button>
    </div>

    <div class="itinerary-container">
        <div th:each="day, iterStat : ${dateList}" class="day-card">
            <div class="day-title">
                Day [[${iterStat.index + 1}]] ([[${day}]])
            </div>

            <button class="btn btn-location" onclick="openPlaceModal(this)">‚ûï Ïû•ÏÜå Ï∂îÍ∞Ä</button>
            <button class="btn btn-memo" onclick="addMemo(this)">üìù Î©îÎ™® Ï∂îÍ∞Ä</button>

            <div class="entry-list"></div>
        </div>
    </div>

    <script>
        let currentEntryList = null;
        let cityIds = /*[[${cityIds}]]*/ [1, 2, 3]; // ÏÑúÎ≤ÑÏóêÏÑú Î™®Îç∏Î°ú ÎÑòÍ∏¥ ÎèÑÏãú ID Î¶¨Ïä§Ìä∏

        function openPlaceModal(button) {
            currentEntryList = button.closest('.day-card').querySelector('.entry-list');
            document.getElementById('placeModal').style.display = 'block';
            document.getElementById('autocomplete').value = '';
            document.getElementById('recommendationList').style.display = 'block';
            loadRecommendations(cityIds);
        }

        function closeModal() {
            document.getElementById('placeModal').style.display = 'none';
        }

        function handleInput() {
            const input = document.getElementById('autocomplete').value;
            document.getElementById('recommendationList').style.display = input.trim() === '' ? 'block' : 'none';
        }

        function loadRecommendations(cityIds) {
            const queryParam = cityIds.map(id => `cityIds=${id}`).join('&');
            fetch(`/travel/places/recommend?${queryParam}`)
                .then(res => res.json())
                .then(places => {
                    const list = document.getElementById('recommendationList');
                    list.innerHTML = '';
                    places.forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'recommend-item';
                        div.innerText = `üìç ${place.name}`;
                        div.onclick = () => {
                            const entry = document.createElement('div');
                            entry.className = 'entry-item';
                            entry.innerText = `üìç ${place.name} (${place.address})`;
                            currentEntryList.appendChild(entry);
                            closeModal();
                        };
                        list.appendChild(div);
                    });
                });
        }

        function addMemo(button) {
            const entryList = button.closest('.day-card').querySelector('.entry-list');
            const memo = prompt("Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
            if (memo) {
                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerText = `üìù ${memo}`;
                entryList.appendChild(div);
            }
        }

        function initAutocomplete() {
            const input = document.getElementById('autocomplete');
            const autocomplete = new google.maps.places.Autocomplete(input);

            autocomplete.addListener('place_changed', function () {
                const place = autocomplete.getPlace();
                if (!place.name) return;

                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerText = `üìç ${place.name} (${place.formatted_address || ''})`;
                currentEntryList.appendChild(div);
                closeModal();
            });
        }

        window.initAutocomplete = initAutocomplete;
    </script>

    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api-key')} + '&libraries=places&callback=initAutocomplete'"
            async defer></script>
</div>
</body>
</html>