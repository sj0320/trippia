<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>여행 일정표</title>
    <style>
        .itinerary-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .day-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .day-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .day-title strong {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .day-date {
            font-size: 0.95rem;
            color: #777;
        }


        .btn {
            margin-right: 10px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .btn-location {
            background-color: #6c757d; /* 회색 */
            color: white;
        }

        .btn-location:hover {
            background-color: #5a6268; /* 어두운 회색 */
        }

        .btn-memo {
            background-color: #f0ad4e; /* 금색 */
            color: white;
        }

        .btn-memo:hover {
            background-color: #ec971f; /* 더 어두운 금색 */
        }

        .entry-list {
            margin-top: 15px;
        }

        .entry-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .circle-number {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background-color: #495057; /* 미드나잇 블루 */
            color: white;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .circle-blank {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background-color: #ced4da; /* 연한 회색 */
            margin-right: 10px;
        }

        .entry-item {
            background-color: #f8f9fa; /* 연한 회색 배경 */
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .distance-item {
            margin-left: 36px;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        #placeModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            width: 500px;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #autocomplete {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #recommendationList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fafafa;
        }

        .recommend-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .recommend-item:hover {
            background-color: #e9ecef; /* 회색 강조 */
        }

        #placeModal button {
            padding: 8px 14px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #placeModal button:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
<div layout:fragment="content">

    <div id="placeModal">
        <label for="autocomplete" style="font-weight: bold;">장소 검색</label>
        <input id="autocomplete" type="text" placeholder="장소 검색..." autocomplete="off"/>
        <div id="recommendationList" style="margin-top: 1rem;"></div>
        <button onclick="closeModal()">❌ 닫기</button>
    </div>

    <div class="itinerary-container">
        <div th:each="day, iterStat : ${dateList}" class="day-card">
            <div class="day-title">
                <strong th:text="${iterStat.index + 1} + '일차'"></strong>
                <span class="day-date" th:text="${day}"></span>
            </div>
            <button class="btn btn-location" onclick="openPlaceModal(this)">➕ 장소 추가</button>
            <button class="btn btn-memo" onclick="addMemo(this)">📝 메모 추가</button>
            <div class="entry-list"></div>
        </div>
    </div>

    <script>
        let currentEntryList = null;
        let cityIds = /*[[${cityIds}]]*/ [1, 2, 3];
        let debounceTimer;
        const DEBOUNCE_DELAY = 400;

        document.getElementById('autocomplete').addEventListener('input', function () {
            const query = this.value.trim();
            const list = document.getElementById('recommendationList');
            list.style.display = 'block';
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                loadRecommendations(cityIds, query);
            }, DEBOUNCE_DELAY);
        });

        function openPlaceModal(button) {
            const dayCard = button.closest('.day-card');
            currentEntryList = dayCard.querySelector('.entry-list');

            document.getElementById('placeModal').style.display = 'block';

            const input = document.getElementById('autocomplete');
            const list = document.getElementById('recommendationList');

            input.value = '';
            list.innerHTML = '<p>🔄 장소 추천을 불러오는 중...</p>';
            list.style.display = 'block';

            loadRecommendations(cityIds);
        }

        function closeModal() {
            document.getElementById('placeModal').style.display = 'none';
        }

        function loadRecommendations(cityIds, query = '') {
            const queryParam = cityIds.map(id => `cityIds=${id}`).join('&') + (query ? `&query=${encodeURIComponent(query)}` : '');
            fetch(`/travel/places/recommend?${queryParam}`)
                .then(res => res.json())
                .then(places => {
                    const list = document.getElementById('recommendationList');
                    list.innerHTML = '';
                    if (places.length === 0) {
                        list.innerHTML = '<p>추천 장소가 없습니다.</p>';
                        return;
                    }
                    places.forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'recommend-item';
                        div.style.padding = '15px';
                        div.style.marginBottom = '10px';
                        div.style.backgroundColor = '#fff';
                        div.style.borderRadius = '8px';
                        div.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                        div.style.cursor = 'pointer';
                        div.style.transition = 'transform 0.3s ease';
                        div.style.display = 'flex';
                        div.style.flexDirection = 'column';

                        // 장소 이름과 주소
                        const titleDiv = document.createElement('div');
                        titleDiv.style.fontWeight = 'bold';
                        titleDiv.style.fontSize = '1.1rem';
                        titleDiv.style.color = '#333';
                        titleDiv.innerText = `${place.placeName}`;
                        div.appendChild(titleDiv);

                        const addressDiv = document.createElement('div');
                        addressDiv.style.fontSize = '0.9rem';
                        addressDiv.style.color = '#666';
                        addressDiv.style.marginBottom = '10px';
                        addressDiv.innerText = `${place.address}`;
                        div.appendChild(addressDiv);

                        // 테마 태그
                        if (place.themes && place.themes.length > 0) {
                            const tagContainer = document.createElement('div');
                            tagContainer.style.marginBottom = '8px';
                            tagContainer.style.display = 'flex';
                            tagContainer.style.flexWrap = 'wrap';

                            place.themes.forEach(theme => {
                                const tag = document.createElement('span');
                                tag.innerText = theme;
                                tag.style.backgroundColor = '#e0f7fa';
                                tag.style.color = '#00796b';
                                tag.style.fontSize = '0.85rem';
                                tag.style.padding = '5px 10px';
                                tag.style.marginRight = '8px';
                                tag.style.marginBottom = '5px';
                                tag.style.borderRadius = '16px';
                                tag.style.border = '1px solid #00796b';
                                tag.style.transition = 'background-color 0.2s ease';
                                tag.style.cursor = 'pointer';

                                // 태그 hover 효과
                                tag.onmouseenter = () => tag.style.backgroundColor = '#00796b';
                                tag.onmouseleave = () => tag.style.backgroundColor = '#e0f7fa';
                                tagContainer.appendChild(tag);
                            });
                            div.appendChild(tagContainer);
                        }

                        div.onclick = () => handlePlaceClick(place.placeId);
                        list.appendChild(div);
                    });
                });
        }

        function handlePlaceClick(placeId) {
            const service = new google.maps.places.PlacesService(document.createElement('div'));
            service.getDetails({ placeId: placeId }, (result, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK) {
                    alert("장소 정보를 가져올 수 없습니다.");
                    return;
                }

                const placeEntry = {
                    name: result.name,
                    address: result.formatted_address || result.vicinity,
                    latitude: result.geometry.location.lat(),
                    longitude: result.geometry.location.lng(),
                };

                const entries = currentEntryList.querySelectorAll('.entry-item[data-latitude]');
                let lastPlace = null;
                if (entries.length > 0) {
                    const last = entries[entries.length - 1];
                    lastPlace = {
                        latitude: parseFloat(last.dataset.latitude),
                        longitude: parseFloat(last.dataset.longitude),
                    };
                }

                const placeCount = currentEntryList.querySelectorAll('.circle-number').length + 1;

                const addNumber = () => {
                    const row = document.createElement('div');
                    row.className = 'entry-row';

                    const circle = document.createElement('div');
                    circle.className = 'circle-number';
                    circle.innerText = placeCount;

                    const placeDiv = document.createElement('div');
                    placeDiv.className = 'entry-item';
                    placeDiv.innerText = `📍 ${placeEntry.name} (${placeEntry.address})`;
                    placeDiv.dataset.latitude = placeEntry.latitude;
                    placeDiv.dataset.longitude = placeEntry.longitude;

                    row.appendChild(circle);
                    row.appendChild(placeDiv);
                    currentEntryList.appendChild(row);
                };

                if (lastPlace) {
                    calculateDistanceAndDisplay(lastPlace, placeEntry, (distanceText) => {
                        const distanceDiv = document.createElement('div');
                        distanceDiv.className = 'distance-item';
                        distanceDiv.innerText = `거리: ${distanceText}`;
                        currentEntryList.appendChild(distanceDiv);
                        addNumber();
                        closeModal();
                    });
                } else {
                    addNumber();
                    closeModal();
                }
            });
        }

        function calculateDistanceAndDisplay(prevPlace, newPlace, callback) {
            const R = 6371;
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(newPlace.latitude - prevPlace.latitude);
            const dLon = toRad(newPlace.longitude - prevPlace.longitude);
            const lat1 = toRad(prevPlace.latitude);
            const lat2 = toRad(newPlace.latitude);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            callback(`${distance.toFixed(2)} km`);
        }

        function addMemo(button) {
            const entryList = button.closest('.day-card').querySelector('.entry-list');
            const memo = prompt("메모를 입력하세요:");
            if (memo) {
                const row = document.createElement('div');
                row.className = 'entry-row';

                const circle = document.createElement('div');
                circle.className = 'circle-blank';

                const div = document.createElement('div');
                div.className = 'entry-item';
                div.innerText = `📝 ${memo}`;

                row.appendChild(circle);
                row.appendChild(div);
                entryList.appendChild(row);
            }
        }
    </script>

    <script th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${@environment.getProperty('google.maps.api-key')} + '&libraries=places,geometry&loading=async'" async></script>
</div>
</body>
</html>